<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuÃ©t mÃ£ QR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <h2>QuÃ©t mÃ£ QR</h2>
    <div id="reader" style="width: 300px;"></div>
    <div id="result" style="margin-top: 20px; font-size: 18px;"></div>

<script>
    let lastScannedUUID = ""; // LÆ°u UUID quÃ©t gáº§n nháº¥t
    let scanningBlocked = false; // NgÄƒn quÃ©t liÃªn tá»¥c

    function onScanSuccess(qrMessage) {
        if (scanningBlocked || qrMessage === lastScannedUUID) {
            return; // Bá» qua náº¿u mÃ£ trÃ¹ng hoáº·c Ä‘ang trong thá»i gian chá»
        }

        lastScannedUUID = qrMessage; // Cáº­p nháº­t UUID quÃ©t gáº§n nháº¥t
        scanningBlocked = true; // Cháº·n quÃ©t tiáº¿p trong thá»i gian chá»

        fetch(`/check-ticket/?uuid=${qrMessage}`)
            .then(response => response.json())
            .then(data => {
                let resultDiv = document.getElementById("result");
                if (data.valid) {
                    resultDiv.innerHTML = `
                        <p style="color: green;">âœ… ${data.message}</p>
                        <p>ğŸ‘¤ <strong>KhÃ¡ch hÃ ng:</strong> ${data.customer}</p>
                        <p>ğŸ¬ <strong>Phim:</strong> ${data.movie}</p>
                        <p>ğŸ•’ <strong>Giá» chiáº¿u:</strong> ${data.time}</p>
                        <p>ğŸŸ <strong>Gháº¿:</strong> ${data.seat}</p>
                        <p>ğŸ’° <strong>Tá»•ng tiá»n:</strong> ${data.total_price}</p>
                        <p>ğŸ’³ <strong>Thanh toÃ¡n:</strong> ${data.payment_method}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p style="color: red;">âŒ ${data.message}</p>
                        ${data.used_time ? `<p>ğŸ•’ ÄÃ£ quÃ©t lÃºc: ${data.used_time}</p>` : ''}
                    `;
                }

                // Cho phÃ©p quÃ©t láº¡i sau 3 giÃ¢y
                setTimeout(() => {
                    scanningBlocked = false;
                }, 3000);
            })
            .catch(error => console.error("Lá»—i kiá»ƒm tra vÃ©:", error));
    }

    let html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
    );
</script>
</body>
</html>
